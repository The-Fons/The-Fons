<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR/VR Genealogy Tree</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 15px;
        }
        
        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 1);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        #status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="controls">
            <button id="arBtn" class="control-btn">Enter AR</button>
            <button id="vrBtn" class="control-btn">Enter VR</button>
            <button id="resetBtn" class="control-btn">Reset View</button>
        </div>
        
        <div id="status">Desktop Mode</div>
        
        <div id="info">
            <h3>Genealogy Tree Explorer</h3>
            <p>Desktop: Click and drag to rotate, scroll to zoom</p>
            <p>AR/VR: Use hand tracking or controllers to interact with family members</p>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls;
        let familyTree = [];
        let currentMode = 'desktop';
        let xrSession = null;
        
        // Sample family data
        const familyData = [
            { name: "Great Grandpa John", generation: 0, position: [0, 3, 0], birth: "1920", death: "1995" },
            { name: "Great Grandma Mary", generation: 0, position: [2, 3, 0], birth: "1922", death: "1998" },
            { name: "Grandpa Robert", generation: 1, position: [-2, 1.5, 0], birth: "1945", death: "2010" },
            { name: "Grandma Susan", generation: 1, position: [0, 1.5, 0], birth: "1947", death: "" },
            { name: "Grandpa William", generation: 1, position: [2, 1.5, 0], birth: "1943", death: "2005" },
            { name: "Grandma Patricia", generation: 1, position: [4, 1.5, 0], birth: "1948", death: "" },
            { name: "Dad Michael", generation: 2, position: [-1, 0, 0], birth: "1970", death: "" },
            { name: "Mom Jennifer", generation: 2, position: [1, 0, 0], birth: "1972", death: "" },
            { name: "Uncle David", generation: 2, position: [3, 0, 0], birth: "1968", death: "" },
            { name: "Aunt Lisa", generation: 2, position: [5, 0, 0], birth: "1975", death: "" },
            { name: "You", generation: 3, position: [0, -1.5, 0], birth: "1995", death: "" },
            { name: "Sister Emily", generation: 3, position: [2, -1.5, 0], birth: "1998", death: "" },
            { name: "Cousin Jake", generation: 3, position: [4, -1.5, 0], birth: "1993", death: "" }
        ];

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 8);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Create family tree
            createFamilyTree();
            
            // Mouse controls for desktop
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;
            
            renderer.domElement.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            renderer.domElement.addEventListener('mousemove', (e) => {
                if (!mouseDown) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                scene.rotation.y += deltaX * 0.01;
                scene.rotation.x += deltaY * 0.01;
                
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            renderer.domElement.addEventListener('mouseup', () => {
                mouseDown = false;
            });
            
            renderer.domElement.addEventListener('wheel', (e) => {
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(3, Math.min(15, camera.position.z));
            });
            
            // Button event listeners
            document.getElementById('arBtn').addEventListener('click', enterAR);
            document.getElementById('vrBtn').addEventListener('click', enterVR);
            document.getElementById('resetBtn').addEventListener('click', resetView);
            
            // Check XR support
            checkXRSupport();
            
            animate();
        }
        
        function createFamilyTree() {
            const cardGeometry = new THREE.PlaneGeometry(1.5, 1);
            
            familyData.forEach((person, index) => {
                // Create card background
                const cardMaterial = new THREE.MeshLambertMaterial({ 
                    color: getGenerationColor(person.generation),
                    transparent: true,
                    opacity: 0.9
                });
                
                const card = new THREE.Mesh(cardGeometry, cardMaterial);
                card.position.set(...person.position);
                card.userData = person;
                scene.add(card);
                
                // Create text canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 512;
                canvas.height = 256;
                
                context.fillStyle = 'white';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                context.fillStyle = 'black';
                context.font = 'bold 32px Arial';
                context.textAlign = 'center';
                context.fillText(person.name, canvas.width / 2, 60);
                
                context.font = '24px Arial';
                context.fillText(`Born: ${person.birth}`, canvas.width / 2, 120);
                if (person.death) {
                    context.fillText(`Died: ${person.death}`, canvas.width / 2, 160);
                }
                
                // Create text texture
                const textTexture = new THREE.CanvasTexture(canvas);
                const textMaterial = new THREE.MeshBasicMaterial({ 
                    map: textTexture,
                    transparent: true
                });
                
                const textMesh = new THREE.Mesh(cardGeometry, textMaterial);
                textMesh.position.set(person.position[0], person.position[1], person.position[2] + 0.01);
                scene.add(textMesh);
                
                // Add connecting lines
                if (person.generation > 0) {
                    const parentConnections = getParentConnections(person, familyData);
                    parentConnections.forEach(parent => {
                        const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                            new THREE.Vector3(...person.position),
                            new THREE.Vector3(...parent.position)
                        ]);
                        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x8B4513 });
                        const line = new THREE.Line(lineGeometry, lineMaterial);
                        scene.add(line);
                    });
                }
                
                familyTree.push({ card, textMesh, person });
            });
        }
        
        function getGenerationColor(generation) {
            const colors = [0xFF6B6B, 0x4ECDC4, 0x45B7D1, 0x96CEB4, 0xDDA0DD];
            return colors[generation % colors.length];
        }
        
        function getParentConnections(person, data) {
            // Simple logic to connect generations - in a real app, you'd have proper parent-child relationships
            if (person.generation === 0) return [];
            
            return data.filter(p => p.generation === person.generation - 1);
        }
        
        async function checkXRSupport() {
            if ('xr' in navigator) {
                try {
                    const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                    const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                    
                    document.getElementById('arBtn').disabled = !arSupported;
                    document.getElementById('vrBtn').disabled = !vrSupported;
                    
                    if (!arSupported && !vrSupported) {
                        document.getElementById('info').innerHTML += '<p style="color: yellow;">XR not supported on this device</p>';
                    }
                } catch (error) {
                    console.log('XR support check failed:', error);
                    document.getElementById('arBtn').disabled = true;
                    document.getElementById('vrBtn').disabled = true;
                }
            } else {
                document.getElementById('arBtn').disabled = true;
                document.getElementById('vrBtn').disabled = true;
                document.getElementById('info').innerHTML += '<p style="color: yellow;">WebXR not available</p>';
            }
        }
        
        async function enterAR() {
            try {
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['hand-tracking', 'hit-test']
                });
                
                await renderer.xr.setSession(xrSession);
                currentMode = 'AR';
                document.getElementById('status').textContent = 'AR Mode';
                
                // Position family tree in front of user for AR
                positionTreeForXR('AR');
                
                // Make background transparent for AR
                scene.background = null;
                
                xrSession.addEventListener('end', () => {
                    currentMode = 'desktop';
                    document.getElementById('status').textContent = 'Desktop Mode';
                    // Restore background
                    scene.background = new THREE.Color(0x87CEEB);
                    resetTreePosition();
                });
                
            } catch (error) {
                console.error('Failed to enter AR:', error);
                alert('Failed to enter AR mode. Make sure you\'re on a compatible device.');
            }
        }
        
        async function enterVR() {
            try {
                xrSession = await navigator.xr.requestSession('immersive-vr', {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['hand-tracking']
                });
                
                await renderer.xr.setSession(xrSession);
                currentMode = 'VR';
                document.getElementById('status').textContent = 'VR Mode';
                
                // Position family tree around user for VR
                positionTreeForXR('VR');
                
                // Keep background for VR immersion
                scene.background = new THREE.Color(0x1a1a2e);
                
                xrSession.addEventListener('end', () => {
                    currentMode = 'desktop';
                    document.getElementById('status').textContent = 'Desktop Mode';
                    // Restore background
                    scene.background = new THREE.Color(0x87CEEB);
                    resetTreePosition();
                });
                
            } catch (error) {
                console.error('Failed to enter VR:', error);
                alert('Failed to enter VR mode. Make sure you\'re on a compatible device.');
            }
        }
        
        function positionTreeForXR(mode) {
            const treeGroup = new THREE.Group();
            
            // Move all family tree elements to the group
            familyTree.forEach(item => {
                scene.remove(item.card);
                scene.remove(item.textMesh);
                treeGroup.add(item.card);
                treeGroup.add(item.textMesh);
            });
            
            // Remove existing lines and recreate them in the group
            const linesToRemove = [];
            scene.traverse(child => {
                if (child.type === 'Line') {
                    linesToRemove.push(child);
                }
            });
            linesToRemove.forEach(line => scene.remove(line));
            
            // Recreate connection lines in the group
            familyData.forEach(person => {
                if (person.generation > 0) {
                    const parentConnections = getParentConnections(person, familyData);
                    parentConnections.forEach(parent => {
                        const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                            new THREE.Vector3(...person.position),
                            new THREE.Vector3(...parent.position)
                        ]);
                        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x8B4513 });
                        const line = new THREE.Line(lineGeometry, lineMaterial);
                        treeGroup.add(line);
                    });
                }
            });
            
            if (mode === 'AR') {
                // Position tree 2 meters in front of user at table height
                treeGroup.position.set(0, -0.5, -2);
                treeGroup.scale.set(0.3, 0.3, 0.3); // Smaller for AR
            } else if (mode === 'VR') {
                // Position tree 3 meters in front of user at eye level
                treeGroup.position.set(0, 0, -3);
                treeGroup.scale.set(0.5, 0.5, 0.5); // Medium size for VR
            }
            
            scene.add(treeGroup);
            scene.userData.treeGroup = treeGroup;
        }
        
        function resetTreePosition() {
            if (scene.userData.treeGroup) {
                scene.remove(scene.userData.treeGroup);
                
                // Re-add elements to scene at original positions
                familyTree.forEach(item => {
                    scene.add(item.card);
                    scene.add(item.textMesh);
                });
                
                // Recreate connection lines in scene
                familyData.forEach(person => {
                    if (person.generation > 0) {
                        const parentConnections = getParentConnections(person, familyData);
                        parentConnections.forEach(parent => {
                            const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                                new THREE.Vector3(...person.position),
                                new THREE.Vector3(...parent.position)
                            ]);
                            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x8B4513 });
                            const line = new THREE.Line(lineGeometry, lineMaterial);
                            scene.add(line);
                        });
                    }
                });
                
                scene.userData.treeGroup = null;
            }
        }
        
        function animate() {
            renderer.setAnimationLoop(() => {
                // Gentle rotation animation for visual appeal
                if (currentMode === 'desktop') {
                    familyTree.forEach((item, index) => {
                        item.card.rotation.z = Math.sin(Date.now() * 0.001 + index * 0.5) * 0.05;
                        item.textMesh.rotation.z = item.card.rotation.z;
                    });
                }
                
                renderer.render(scene, camera);
            });
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        window.addEventListener('resize', onWindowResize);
        
        // Initialize the application
        init();
    </script>
</body>
</html>
